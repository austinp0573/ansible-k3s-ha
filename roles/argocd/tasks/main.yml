---
# argocd gitops deployment
# continuous delivery for kubernetes applications

- name: check if argocd is already installed
  ansible.builtin.command:
    cmd: k3s kubectl get namespace argocd
  register: argocd_ns
  failed_when: false
  changed_when: false

- name: install argocd
  when: argocd_ns.rc != 0
  block:
    - name: create argocd namespace
      ansible.builtin.command:
        cmd: k3s kubectl create namespace argocd
      changed_when: true

    - name: install argocd via kubectl
      ansible.builtin.command:
        cmd: k3s kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/v2.13.2/manifests/install.yaml
      changed_when: true

    - name: wait for argocd server to be ready
      ansible.builtin.command:
        cmd: k3s kubectl -n argocd rollout status deployment/argocd-server --timeout=600s
      changed_when: false

    - name: wait for argocd repo server to be ready
      ansible.builtin.command:
        cmd: k3s kubectl -n argocd rollout status deployment/argocd-repo-server --timeout=600s
      changed_when: false

    - name: wait for argocd application controller to be ready
      ansible.builtin.command:
        cmd: k3s kubectl -n argocd rollout status statefulset/argocd-application-controller --timeout=600s
      changed_when: false

- name: patch argocd-server to disable tls (for port-forward access)
  ansible.builtin.command:
    cmd: k3s kubectl -n argocd patch deployment argocd-server --type='json' -p='[{"op":"add","path":"/spec/template/spec/containers/0/command/-","value":"--insecure"}]'
  changed_when: false
  failed_when: false

- name: verify argocd installation
  ansible.builtin.command:
    cmd: k3s kubectl -n argocd get pods
  register: argocd_pods
  changed_when: false

- name: display argocd status
  ansible.builtin.debug:
    msg: "{{ argocd_pods.stdout_lines }}"