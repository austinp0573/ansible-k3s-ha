---
# unmount filesystem with children
# recursively unmounts a filesystem and all its child mounts
# used during k3s cleanup to ensure all container mounts are removed

- name: Get list of mounted filesystems
  ansible.builtin.shell: |
    set -o pipefail
    mount | awk '{print $3}' | grep "^{{ mounted_fs }}" | sort -r
  args:
    executable: /bin/bash
  register: mounts_to_unmount
  changed_when: false
  failed_when: false

- name: Unmount filesystems
  ansible.posix.mount:
    path: "{{ item }}"
    state: unmounted
  loop: "{{ mounts_to_unmount.stdout_lines }}"
  when: mounts_to_unmount.stdout_lines | length > 0
  failed_when: false
